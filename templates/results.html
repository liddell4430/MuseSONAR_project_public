<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>MuseSonar - ë¶„ì„ ê²°ê³¼</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
</head>
<script>
    document.addEventListener('DOMContentLoaded', () => {
    const revealItems = document.querySelectorAll('.reveal-item');
    if (revealItems.length === 0) {
        console.warn('ì• ë‹ˆë©”ì´ì…˜ ëŒ€ìƒ(.reveal-item)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. results.htmlì— í•´ë‹¹ í´ë˜ìŠ¤ê°€ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
        return;
    }
    const baseInterval = 1.25; \
    
    revealItems.forEach((item, idx) => {
        item.style.transitionDelay = `${idx * baseInterval}s`;
        item.classList.add('is-visible');
        \
    });
    });
    </script>
<body>
    <div class="container">
        <h1>MuseSonar ë¶„ì„ ê²°ê³¼</h1>

        {% if user_idea %}
        <div class="user-idea-display reveal-item">
            <h2>ğŸ’¡ ì‚¬ìš©ì ì…ë ¥ ì•„ì´ë””ì–´ í…ìŠ¤íŠ¸</h2>
            <p class="idea-text-content">{{ user_idea }}</p>
        </div>
        {% endif %}

        {# 1. ì˜¤ë¥˜ ë©”ì‹œì§€ #}
        {% if result.error %}
            <div class="error-message reveal-item">
                <h2>ì˜¤ë¥˜ ë°œìƒ</h2>
                <p>{{ result.error }}</p>
            </div>
        {% else %}
            {# 2. ê²°ê³¼ ìš”ì•½ #}
            <div class="result-summary reveal-item">
                <h2>ğŸ“Š ì•„ì´ë””ì–´ ê³ ìœ ì„± í‰ê°€: {{ result.rating or 'í‰ê°€ ë¶ˆê°€' }}</h2>
                {% if result.score is not none %}
                    <div class="score-display">
                        <div id="scoreGaugeChart">
                            <canvas id="gaugeChart"></canvas>
                        </div>
                        <div class="score-text-display">
                            <span class="score-value" id="scoreTextValue">{{ result.score }}</span>
                        </div>
                    </div>
                {% else %}
                    <p>â­ ê³ ìœ ì„± : ê³„ì‚° ë¶ˆê°€ ë˜ëŠ” ì •ë³´ ë¶€ì¡±</p>
                {% endif %}
                {% if interpretation_html %}
                <div class="interpretation"> 
                    {{ interpretation_html | safe }} 
                </div>
                {% elif result.interpretation %} 
                <p class="interpretation">{{ result.interpretation }}</p>
                {% endif %}
                {% if warning_html %} 
                <div class="warning">
                    {{ warning_html | safe }} 
                </div>
                {% elif result.warning %} 
                <div class="warning">{{ result.warning }}</div> 
                {% endif %}
            </div>

            {# 3. í‰ê°€ ê·¼ê±° #}
            {% if result.metrics %}
            <div class="metrics reveal-item">
                <h2>ğŸ” í‰ê°€ ê·¼ê±° ìƒì„¸</h2>
                <ul>
                    {% if result.metrics.combined_results_found %}
                        <li class="reveal-item">
                            <strong>ì›¹/íŠ¹í—ˆ ê°œë… ë°€ë„ (í‰ê·  ìœ ì‚¬ë„):</strong>
                            {% if result.metrics.concept_density_percentage is not none %}
                                {{ "%.2f"|format(result.metrics.concept_density_percentage) }}%
                                (ê´€ë ¨ì„± ë†’ì€ {{ result.metrics.relevant_search_results_count }}ê°œ ê²°ê³¼ ê¸°ì¤€)
                            {% else %}
                                ê´€ë ¨ì„± ë†’ì€ ì •ë³´ ì—†ìŒ
                            {% endif %}
                        </li>
                        <li class="reveal-item">
                            <strong>êµ¬ì²´ì  êµ¬í˜„ ì¦ê±° (ë°œê²¬ìœ¨):</strong>
                            {% if result.metrics.verification_attempts > 0 and result.metrics.evidence_discovery_rate_percentage is not none %}
                                {{ "%.1f"|format(result.metrics.evidence_discovery_rate_percentage) }}%
                                ({{ result.metrics.evidence_count }}ê°œ / {{ result.metrics.verification_attempts }}ê°œ ê²€ì¦)
                            {% elif result.metrics.relevant_search_results_count > 0 %}
                                ê²€ì¦ ëŒ€ìƒ ê²°ê³¼ ì—†ìŒ (ìœ ì‚¬ë„ < {{ "%.0f"|format(result.metrics.verification_threshold_percentage) }}%)
                            {% else %}
                                í•´ë‹¹ ì‚¬í•­ ì—†ìŒ
                            {% endif %}
                        </li>
                    {% else %}
                        <li class="reveal-item">ì›¹/íŠ¹í—ˆ ê²€ìƒ‰ ê²°ê³¼: ì•„ì´ë””ì–´ ê´€ë ¨ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ë¶„ì„ ë¶ˆê°€.</li>
                    {% endif %}
                </ul>
            </div>
            {% endif %}

            {# 4. ìœ ì‚¬ ê²°ê³¼ ëª©ë¡ #}
            {% if result.top_similar_results %}
            <div class="similar-results reveal-item">
                <h2>ğŸ“‹ ì°¸ê³ : ê°€ì¥ ìœ ì‚¬í•œ ì›¹/íŠ¹í—ˆ ì •ë³´ (ìƒìœ„ {{ result.top_similar_results|length }}ê°œ)</h2>
                <ul>
                    {% for item in result.top_similar_results %}
                    <li class="reveal-item">
                        <div>
                            <span class="rank">#{{ item.rank }}</span>
                            <strong>ìœ ì‚¬ë„: {{ "%.2f"|format(item.similarity_percentage) }}%</strong>
                            <span class="source">{{ item.source }}</span>
                        </div>
                        <div class="content">ë‚´ìš©: {{ item.content_preview }}</div>
                        {% if item.link %}
                            <div class="link"><a href="{{ item.link }}" target="_blank">ì¶œì²˜ ë§í¬</a></div>
                        {% endif %}
                        {% if item.llm_verification %}
                            <div class="llm-verification">
                                LLM ë¶„ì„:
                                {% set status = item.llm_verification.status %}
                                {% set reason = item.llm_verification.reason %}
                                <span class="status">
                                    {% if status == 'Yes' %}<span class="icon">âœ…</span> ìœ ì‚¬ êµ¬í˜„ ê°€ëŠ¥ì„± ë†’ìŒ
                                    {% elif status == 'No' %}<span class="icon">âŒ</span> êµ¬ì²´ì  êµ¬í˜„ ì¦ê±° ë¯¸í™•ì¸
                                    {% elif status == 'Unclear' %}<span class="icon">â“</span> íŒë‹¨ ë¶ˆë¶„ëª…
                                    {% elif status == 'Error' %}<span class="icon">âš ï¸</span> ë¶„ì„ ì˜¤ë¥˜
                                    {% elif status == 'Skipped' %}<span class="icon">â­ï¸</span> ë¶„ì„ ê±´ë„ˆëœ€
                                    {% else %}{{ status }}
                                    {% endif %}
                                </span>
                                {% if reason and status != 'Skipped' %}
                                    <div class="reason">ã„´ íŒë‹¨ ê·¼ê±°: {{ reason }}</div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="llm-verification">LLM ë¶„ì„: ìˆ˜í–‰ë˜ì§€ ì•ŠìŒ</div>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% else %}
                <p class="reveal-item">í‘œì‹œí•  ìœ ì‚¬ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
        {% endif %} {# End of if not result.error #}

        <a href="{{ url_for('index') }}" class="back-link reveal-item">ë‹¤ë¥¸ ì•„ì´ë””ì–´ ë¶„ì„í•˜ê¸°</a>
    </div>

    <script>
        // result.score ê°’ì´ ì—†ê±°ë‚˜ ìˆ«ìê°€ ì•„ë‹ ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ ê¸°ë³¸ê°’ 0ìœ¼ë¡œ ì²˜ë¦¬
        // (ê¸°ì¡´ ì½”ë“œì˜ const score ë³€ìˆ˜ì™€ ë™ì¼í•œ ì—­í• )
        const scoreValue = {{ result.score if result.score is not none and result.score is number else 0 }};
    
        // HTMLì—ì„œ id="scoreTextValue"ë¡œ ì§€ì •í•œ ì ìˆ˜ í…ìŠ¤íŠ¸ ìš”ì†Œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const scoreTextElement = document.getElementById('scoreTextValue');
    
        // ì ìˆ˜ êµ¬ê°„ì— ë”°ë¥¸ ìƒ‰ìƒì„ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜ (ê¸°ì¡´ í•¨ìˆ˜ì™€ ë™ì¼)
        function getScoreColor(value) {
            if (value >= 85) return '#2ecc71'; // ì´ˆë¡ìƒ‰ ê³„ì—´
            if (value >= 70) return '#f1c40f'; // ë…¸ë€ìƒ‰ ê³„ì—´
            if (value >= 40) return '#e67e22'; // ì£¼í™©ìƒ‰ ê³„ì—´
            return '#e74c3c';          // ë¹¨ê°„ìƒ‰ ê³„ì—´
        }
    
        // í˜„ì¬ ì ìˆ˜ì— í•´ë‹¹í•˜ëŠ” ìƒ‰ìƒ ê³„ì‚° (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
        const scoreColorForChartAndText = getScoreColor(scoreValue); // ë³€ìˆ˜ëª… ëª…í™•í™”
    
        // ì ìˆ˜ í…ìŠ¤íŠ¸ ìš”ì†Œê°€ ì¡´ì¬í•˜ê³ , scoreValueê°€ ìœ íš¨í•  ë•Œ (0ì  í¬í•¨) ìƒ‰ìƒ ë³€ê²½
        if (scoreTextElement && scoreValue >= 0) {
            scoreTextElement.style.color = scoreColorForChartAndText;
        }
    
        // ì°¨íŠ¸ ë¡œì§ì€ scoreValueê°€ 0ë³´ë‹¤ í´ ë•Œë§Œ ì‹¤í–‰ (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
        if (scoreValue > 0) {
            const ctx = document.getElementById('gaugeChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [scoreValue, 100 - scoreValue],
                        backgroundColor: [scoreColorForChartAndText, '#ecf0f1'], // ì°¨íŠ¸ ìƒ‰ìƒ ì ìš©
                        borderColor: '#ffffff',
                        borderWidth: 2,
                        circumference: 180,
                        rotation: 270
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    cutout: '70%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                        datalabels: {
                            display: false, 
                    }
                },
                plugins: [ChartDataLabels] // ChartDataLabels í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
            });
        } else if (scoreTextElement) {
            // ì ìˆ˜ê°€ 0ì´ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šì•„ ì°¨íŠ¸ë¥¼ ê·¸ë¦¬ì§€ ì•Šì„ ë•Œ,
            // scoreTextElementì˜ ìƒ‰ìƒì€ ì´ë¯¸ ìœ„ì—ì„œ scoreColorForChartAndTextì— ë”°ë¼ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.
            // (0ì ì¼ ê²½ìš° getScoreColor(0)ì— ì˜í•´ ë¹¨ê°„ìƒ‰(#e74c3c)ì´ ë©ë‹ˆë‹¤.)
            // ë§Œì•½ 0ì ì¼ ë•Œ ë‹¤ë¥¸ íŠ¹ì • ìƒ‰(ì˜ˆ: ê²€ì •)ì„ ì›í•œë‹¤ë©´ ì—¬ê¸°ì„œ ë‹¤ì‹œ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ì˜ˆ: if (scoreValue === 0) scoreTextElement.style.color = '#333333';
        }
    </script>
</body>
</html>